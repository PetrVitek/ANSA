<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>INET Framework for OMNeT++/OMNEST: OSPF::HelloHandler Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">INET Framework for OMNeT++/OMNEST</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_o_s_p_f_1_1_hello_handler.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">OSPF::HelloHandler Class Reference</div>  </div>
</div>
<div class="contents">
<!-- doxytag: class="OSPF::HelloHandler" --><!-- doxytag: inherits="OSPF::IMessageHandler" -->
<p><code>#include &lt;HelloHandler.h&gt;</code></p>
<div class="dynheader">
Inheritance diagram for OSPF::HelloHandler:</div>
<div class="dyncontent">
 <div class="center">
  <img src="class_o_s_p_f_1_1_hello_handler.png" usemap="#OSPF::HelloHandler_map" alt=""/>
  <map id="OSPF::HelloHandler_map" name="OSPF::HelloHandler_map">
<area href="class_o_s_p_f_1_1_i_message_handler.html" alt="OSPF::IMessageHandler" shape="rect" coords="0,0,151,24"/>
</map>
 </div></div>

<p><a href="class_o_s_p_f_1_1_hello_handler-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_s_p_f_1_1_hello_handler.html#a68abd842d191000fd909a237f274c4b9">HelloHandler</a> (<a class="el" href="class_o_s_p_f_1_1_router.html">Router</a> *containingRouter)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_o_s_p_f_1_1_hello_handler.html#a61a40e4c5d465a0119db5f51e1929475">ProcessPacket</a> (OSPFPacket *packet, <a class="el" href="class_o_s_p_f_1_1_interface.html">Interface</a> *intf, <a class="el" href="class_o_s_p_f_1_1_neighbor.html">Neighbor</a> *unused=NULL)</td></tr>
</table>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a68abd842d191000fd909a237f274c4b9"></a><!-- doxytag: member="OSPF::HelloHandler::HelloHandler" ref="a68abd842d191000fd909a237f274c4b9" args="(Router *containingRouter)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">OSPF::HelloHandler::HelloHandler </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="class_o_s_p_f_1_1_router.html">OSPF::Router</a> *&#160;</td>
          <td class="paramname"><em>containingRouter</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">                                                           :
    <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#afa003e6c747b4a1961dede68915231ee">OSPF::IMessageHandler</a>(containingRouter)
{
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a61a40e4c5d465a0119db5f51e1929475"></a><!-- doxytag: member="OSPF::HelloHandler::ProcessPacket" ref="a61a40e4c5d465a0119db5f51e1929475" args="(OSPFPacket *packet, Interface *intf, Neighbor *unused=NULL)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void OSPF::HelloHandler::ProcessPacket </td>
          <td>(</td>
          <td class="paramtype">OSPFPacket *&#160;</td>
          <td class="paramname"><em>packet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_s_p_f_1_1_interface.html">OSPF::Interface</a> *&#160;</td>
          <td class="paramname"><em>intf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a> *&#160;</td>
          <td class="paramname"><em>unused</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Implements <a class="el" href="class_o_s_p_f_1_1_i_message_handler.html#a43972c1d4506fbc22085c992e70fdd5c">OSPF::IMessageHandler</a>.</p>
<div class="fragment"><pre class="fragment">{
    OSPFHelloPacket* helloPacket         = check_and_cast&lt;OSPFHelloPacket*&gt; (packet);
    <span class="keywordtype">bool</span>             rebuildRoutingTable = <span class="keyword">false</span>;

    <span class="comment">/* The values of the Network Mask, HelloInterval,</span>
<span class="comment">       and RouterDeadInterval fields in the received Hello packet must</span>
<span class="comment">       be checked against the values configured for the receiving</span>
<span class="comment">       interface.  Any mismatch causes processing to stop and the</span>
<span class="comment">       packet to be dropped.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> ((intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#acbe4102fed53ad77e349da0ed816c023">GetHelloInterval</a>() == helloPacket-&gt;getHelloInterval()) &amp;&amp;
        (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#ace7825b52c05dd76bc3cf34081f27130">GetRouterDeadInterval</a>() == helloPacket-&gt;getRouterDeadInterval()))
    {
        <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4ac">OSPF::Interface::OSPFInterfaceType</a> interfaceType = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#afc695bd11de24180427aef1161c772a9">GetType</a>();
        <span class="comment">/* There is one exception to the above rule: on point-to-point</span>
<span class="comment">           networks and on virtual links, the Network Mask in the received</span>
<span class="comment">           Hello Packet should be ignored.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (!((interfaceType != <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4aca4dac0c4eca27454daabf38ea32f47775">OSPF::Interface::PointToPoint</a>) &amp;&amp;
              (interfaceType != <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4acaf27b340cd6ffc282630c03185294088b">OSPF::Interface::Virtual</a>) &amp;&amp;
              (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a13403146ed20a460dc19fc9089e55c90">GetAddressRange</a>().mask != <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(helloPacket-&gt;getNetworkMask().getInt()))
             )
           )
        {
            <span class="comment">/* The setting of the E-bit found in the Hello Packet&#39;s Options field must match this area&#39;s</span>
<span class="comment">               ExternalRoutingCapability.</span>
<span class="comment">             */</span>
            <span class="keywordflow">if</span> (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a353330e70282153a34fcf9d4ee276acc">GetArea</a>()-&gt;GetExternalRoutingCapability() == helloPacket-&gt;getOptions().E_ExternalRoutingCapability) {
                <a class="code" href="class_i_p_control_info.html">IPControlInfo</a>*      controlInfo             = check_and_cast&lt;<a class="code" href="class_i_p_control_info.html">IPControlInfo</a> *&gt; (helloPacket-&gt;getControlInfo());
                <a class="code" href="struct_o_s_p_f_1_1_i_pv4_address.html">OSPF::IPv4Address</a>   srcAddress              = <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(controlInfo-&gt;getSrcAddr().getInt());
                <span class="keywordtype">bool</span>                neighborChanged         = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>                neighborsDRStateChanged = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>                drChanged               = <span class="keyword">false</span>;
                <span class="keywordtype">bool</span>                backupSeen              = <span class="keyword">false</span>;
                <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>*     neighbor;

                <span class="comment">/* If the receiving interface connects to a broadcast, Point-to-</span>
<span class="comment">                   MultiPoint or NBMA network the source is identified by the IP</span>
<span class="comment">                   source address found in the Hello&#39;s IP header.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">if</span> ((interfaceType == <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4aca15decf080ad941585245418cfb9458c9">OSPF::Interface::Broadcast</a>) ||
                    (interfaceType == <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4aca661d5c29aedcfc3f712b4084e12d51ae">OSPF::Interface::PointToMultiPoint</a>) ||
                    (interfaceType == <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4acae26d6f3ee5ee0f7c1ed2f2196c1dfe07">OSPF::Interface::NBMA</a>))
                {
                    neighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7d77a0ec7d5dea0713174e7e2c678645">GetNeighborByAddress</a>(srcAddress);
                } <span class="keywordflow">else</span> {
                    <span class="comment">/* If the receiving interface connects to a point-to-point link or a virtual link,</span>
<span class="comment">                       the source is identified by the Router ID found in the Hello&#39;s OSPF packet header.</span>
<span class="comment">                     */</span>
                    neighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a62df5516c0a1c6080c654c87927554c0">GetNeighborByID</a>(helloPacket-&gt;getRouterID().getInt());
                }

                <span class="keywordflow">if</span> (neighbor != NULL) {
                    <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#a24cb6c6f9b62a4e403d5171a0d36f22a">router</a>-&gt;GetMessageHandler()-&gt;PrintEvent(<span class="stringliteral">&quot;Hello packet received&quot;</span>, intf, neighbor);

                    IPv4Address                 designatedAddress   = neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a9720f23a8ca94abd5027932d93684ea2">GetDesignatedRouter</a>().ipInterfaceAddress;
                    IPv4Address                 backupAddress       = neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a460e1cfd8816b958fef01acce13ce82b">GetBackupDesignatedRouter</a>().ipInterfaceAddress;
                    <span class="keywordtype">char</span>                        newPriority         = helloPacket-&gt;getRouterPriority();
                    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               source              = controlInfo-&gt;getSrcAddr().getInt();
                    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               newDesignatedRouter = helloPacket-&gt;getDesignatedRouter().getInt();
                    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>               newBackupRouter     = helloPacket-&gt;getBackupDesignatedRouter().getInt();
                    <a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html">OSPF::DesignatedRouterID</a>    dRouterID;

                    <span class="keywordflow">if</span> ((interfaceType == <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4acaf27b340cd6ffc282630c03185294088b">OSPF::Interface::Virtual</a>) &amp;&amp;
                        (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a934bedd2e5f14281416666a48f357bc9">GetState</a>() == <a class="code" href="class_o_s_p_f_1_1_neighbor.html#abe30518a64009a9ae44944c1036a4c0aafffabea956666082e709fc0cc82f6520">OSPF::Neighbor::DownState</a>))
                    {
                        neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a870a8aa258b8d1250b5e13c67688898b">SetPriority</a>(helloPacket-&gt;getRouterPriority());
                        neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a4dca6c45c0bfc9a4e7a1c4d4e13c7d1c">SetRouterDeadInterval</a>(helloPacket-&gt;getRouterDeadInterval());
                    }

                    <span class="comment">/* If a change in the neighbor&#39;s Router Priority field</span>
<span class="comment">                       was noted, the receiving interface&#39;s state machine is</span>
<span class="comment">                       scheduled with the event NeighborChange.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">if</span> (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a81e7ec86bff4a427f34bd091e3fb6698">GetPriority</a>() != newPriority) {
                        neighborChanged = <span class="keyword">true</span>;
                    }

                    <span class="comment">/* If the neighbor is both declaring itself to be Designated</span>
<span class="comment">                       Router(Hello Packet&#39;s Designated Router field = Neighbor IP</span>
<span class="comment">                       address) and the Backup Designated Router field in the</span>
<span class="comment">                       packet is equal to 0.0.0.0 and the receiving interface is in</span>
<span class="comment">                       state Waiting, the receiving interface&#39;s state machine is</span>
<span class="comment">                       scheduled with the event BackupSeen.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">if</span> ((newDesignatedRouter == source) &amp;&amp;
                        (newBackupRouter == 0) &amp;&amp;
                        (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a93b0578a717b1d7ed98780108305c9d5">GetState</a>() == <a class="code" href="class_o_s_p_f_1_1_interface.html#a68805ad1115c7149d5f8a139437e6249a4b12c46ab26b94b0f002e9a8f54ae385">OSPF::Interface::WaitingState</a>))
                    {
                        backupSeen = <span class="keyword">true</span>;
                    } <span class="keywordflow">else</span> {
                        <span class="comment">/* Otherwise, if the neighbor is declaring itself to be Designated Router and it</span>
<span class="comment">                           had not previously, or the neighbor is not declaring itself</span>
<span class="comment">                           Designated Router where it had previously, the receiving</span>
<span class="comment">                           interface&#39;s state machine is scheduled with the event</span>
<span class="comment">                           NeighborChange.</span>
<span class="comment">                         */</span>
                        <span class="keywordflow">if</span> (((newDesignatedRouter == source) &amp;&amp;
                             (newDesignatedRouter != <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(designatedAddress))) ||
                            ((newDesignatedRouter != source) &amp;&amp;
                             (source == <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(designatedAddress))))
                        {
                            neighborChanged = <span class="keyword">true</span>;
                            neighborsDRStateChanged = <span class="keyword">true</span>;
                        }
                    }

                    <span class="comment">/* If the neighbor is declaring itself to be Backup Designated</span>
<span class="comment">                       Router(Hello Packet&#39;s Backup Designated Router field =</span>
<span class="comment">                       Neighbor IP address) and the receiving interface is in state</span>
<span class="comment">                       Waiting, the receiving interface&#39;s state machine is</span>
<span class="comment">                       scheduled with the event BackupSeen.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">if</span> ((newBackupRouter == source) &amp;&amp;
                        (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a93b0578a717b1d7ed98780108305c9d5">GetState</a>() == <a class="code" href="class_o_s_p_f_1_1_interface.html#a68805ad1115c7149d5f8a139437e6249a4b12c46ab26b94b0f002e9a8f54ae385">OSPF::Interface::WaitingState</a>))
                    {
                        backupSeen = <span class="keyword">true</span>;
                    } <span class="keywordflow">else</span> {
                        <span class="comment">/* Otherwise, if the neighbor is declaring itself to be Backup Designated Router</span>
<span class="comment">                           and it had not previously, or the neighbor is not declaring</span>
<span class="comment">                           itself Backup Designated Router where it had previously, the</span>
<span class="comment">                           receiving interface&#39;s state machine is scheduled with the</span>
<span class="comment">                           event NeighborChange.</span>
<span class="comment">                         */</span>
                        <span class="keywordflow">if</span> (((newBackupRouter == source) &amp;&amp;
                             (newBackupRouter != <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(backupAddress))) ||
                            ((newBackupRouter != source) &amp;&amp;
                             (source == <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(backupAddress))))
                        {
                            neighborChanged = <span class="keyword">true</span>;
                        }
                    }

                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad91998f47a8916d1000fec1c77befa9d">SetNeighborID</a>(helloPacket-&gt;getRouterID().getInt());
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a870a8aa258b8d1250b5e13c67688898b">SetPriority</a>(newPriority);
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a4fa4de2681d4abe417553d7883869529">SetAddress</a>(srcAddress);
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = newDesignatedRouter;
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(newDesignatedRouter);
                    <span class="keywordflow">if</span> (newDesignatedRouter != <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(designatedAddress)) {
                        designatedAddress = dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a>;
                        drChanged = <span class="keyword">true</span>;
                    }
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb58da3d58077c7c89045b5c575596fc">SetDesignatedRouter</a>(dRouterID);
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = newBackupRouter;
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(newBackupRouter);
                    <span class="keywordflow">if</span> (newBackupRouter != <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(backupAddress)) {
                        backupAddress = dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a>;
                        drChanged = <span class="keyword">true</span>;
                    }
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#af2e8cb36fbb0c1edf991e3cf031d1541">SetBackupDesignatedRouter</a>(dRouterID);
                    <span class="keywordflow">if</span> (drChanged) {
                        neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ae4aaed5a9eb7477702574a8b50b6c1e0">SetUpDesignatedRouters</a>(<span class="keyword">false</span>);
                    }

                    <span class="comment">/* If the neighbor router&#39;s Designated or Backup Designated Router</span>
<span class="comment">                       has changed it&#39;s necessary to look up the Router IDs belonging to the</span>
<span class="comment">                       new addresses.</span>
<span class="comment">                     */</span>
                    <span class="keywordflow">if</span> (!neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a1b7fd2c538261ac4e0523a8222b4d84f">DesignatedRoutersAreSetUp</a>()) {
                        <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* designated = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7d77a0ec7d5dea0713174e7e2c678645">GetNeighborByAddress</a>(designatedAddress);
                        <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* backup     = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7d77a0ec7d5dea0713174e7e2c678645">GetNeighborByAddress</a>(backupAddress);

                        <span class="keywordflow">if</span> (designated != NULL) {
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>();
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb8fc0467b13a32ccd3b088528bb9266">GetAddress</a>();
                            neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb58da3d58077c7c89045b5c575596fc">SetDesignatedRouter</a>(dRouterID);
                        }
                        <span class="keywordflow">if</span> (backup != NULL) {
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>();
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb8fc0467b13a32ccd3b088528bb9266">GetAddress</a>();
                            neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#af2e8cb36fbb0c1edf991e3cf031d1541">SetBackupDesignatedRouter</a>(dRouterID);
                        }
                        <span class="keywordflow">if</span> ((designated != NULL) &amp;&amp; (backup != NULL)) {
                            neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ae4aaed5a9eb7477702574a8b50b6c1e0">SetUpDesignatedRouters</a>(<span class="keyword">true</span>);
                        }
                    }
                } <span class="keywordflow">else</span> {
                    <a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html">OSPF::DesignatedRouterID</a>    dRouterID;
                    <span class="keywordtype">bool</span>                        designatedSetUp = <span class="keyword">false</span>;
                    <span class="keywordtype">bool</span>                        backupSetUp     = <span class="keyword">false</span>;

                    neighbor = <span class="keyword">new</span> <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>(helloPacket-&gt;getRouterID().getInt());
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a870a8aa258b8d1250b5e13c67688898b">SetPriority</a>(helloPacket-&gt;getRouterPriority());
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a4fa4de2681d4abe417553d7883869529">SetAddress</a>(srcAddress);
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a4dca6c45c0bfc9a4e7a1c4d4e13c7d1c">SetRouterDeadInterval</a>(helloPacket-&gt;getRouterDeadInterval());

                    <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#a24cb6c6f9b62a4e403d5171a0d36f22a">router</a>-&gt;GetMessageHandler()-&gt;PrintEvent(<span class="stringliteral">&quot;Hello packet received&quot;</span>, intf, neighbor);

                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = helloPacket-&gt;getDesignatedRouter().getInt();
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a>);

                    <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* designated = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7d77a0ec7d5dea0713174e7e2c678645">GetNeighborByAddress</a>(dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a>);

                    <span class="comment">// Get the Designated Router ID from the corresponding Neighbor Object.</span>
                    <span class="keywordflow">if</span> (designated != NULL) {
                        <span class="keywordflow">if</span> (designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>() != dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a>) {
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = designated-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>();
                        }
                        designatedSetUp = <span class="keyword">true</span>;
                    }
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb58da3d58077c7c89045b5c575596fc">SetDesignatedRouter</a>(dRouterID);

                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = helloPacket-&gt;getBackupDesignatedRouter().getInt();
                    dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a> = <a class="code" href="_o_s_p_fcommon_8h.html#a5206656cf4131a17505ee9db0a60ddb6">IPv4AddressFromULong</a>(dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a>);

                    <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* backup = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7d77a0ec7d5dea0713174e7e2c678645">GetNeighborByAddress</a>(dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a3e44bfb89c52a2179bfe69cbd73fc30e">ipInterfaceAddress</a>);

                    <span class="comment">// Get the Backup Designated Router ID from the corresponding Neighbor Object.</span>
                    <span class="keywordflow">if</span> (backup != NULL) {
                        <span class="keywordflow">if</span> (backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>() != dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a>) {
                            dRouterID.<a class="code" href="struct_o_s_p_f_1_1_designated_router_i_d.html#a7132bdabe0f15493518622d1b9e84f0f">routerID</a> = backup-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ad80d61e8d0737c7e0a12f1837ac99ffb">GetNeighborID</a>();
                        }
                        backupSetUp = <span class="keyword">true</span>;
                    }
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#af2e8cb36fbb0c1edf991e3cf031d1541">SetBackupDesignatedRouter</a>(dRouterID);
                    <span class="keywordflow">if</span> (designatedSetUp &amp;&amp; backupSetUp) {
                        neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#ae4aaed5a9eb7477702574a8b50b6c1e0">SetUpDesignatedRouters</a>(<span class="keyword">true</span>);
                    }
                    intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a906b7bb39eaf75d7ccc6e7aaa710c724">AddNeighbor</a>(neighbor);
                }

                neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a14aa3724c4f692d5c9635bd24b9dfce7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_neighbor.html#aa11c941b2bc4a36c36fba1cb453a4172a724a7f11da01778981aedda6ed33f6d2">OSPF::Neighbor::HelloReceived</a>);
                <span class="keywordflow">if</span> ((interfaceType == <a class="code" href="class_o_s_p_f_1_1_interface.html#a558b3988a38b079460b57f092eacf4acae26d6f3ee5ee0f7c1ed2f2196c1dfe07">OSPF::Interface::NBMA</a>) &amp;&amp;
                    (intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#afb2510bbc8220f493ab29e16d1019efd">GetRouterPriority</a>() == 0) &amp;&amp;
                    (neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a934bedd2e5f14281416666a48f357bc9">GetState</a>() &gt;= <a class="code" href="class_o_s_p_f_1_1_neighbor.html#abe30518a64009a9ae44944c1036a4c0aad7b22d69601f22f77b0839c2ae33cccd">OSPF::Neighbor::InitState</a>))
                {
                    intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#af5bcfcd208d73be7deeda67c1072ec19">SendHelloPacket</a>(neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#afb8fc0467b13a32ccd3b088528bb9266">GetAddress</a>());
                }

                <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   interfaceAddress       = <a class="code" href="_o_s_p_fcommon_8h.html#a4da9e68bb3ffcba090d1b07a5f812ce3">ULongFromIPv4Address</a>(intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a13403146ed20a460dc19fc9089e55c90">GetAddressRange</a>().address);
                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    neighborsNeighborCount = helloPacket-&gt;getNeighborArraySize();
                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    i;
                <span class="comment">/* The list of neighbors contained in the Hello Packet is</span>
<span class="comment">                   examined.  If the router itself appears in this list, the</span>
<span class="comment">                   neighbor state machine should be executed with the event TwoWayReceived.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">for</span> (i = 0; i &lt; neighborsNeighborCount; i++) {
                    <span class="keywordflow">if</span> (helloPacket-&gt;getNeighbor(i).getInt() == interfaceAddress) {
                        neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a14aa3724c4f692d5c9635bd24b9dfce7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_neighbor.html#aa11c941b2bc4a36c36fba1cb453a4172a6335dbb7e3dbb7b0d9347cf865eec9d3">OSPF::Neighbor::TwoWayReceived</a>);
                        <span class="keywordflow">break</span>;
                    }
                }
                <span class="comment">/* Otherwise, the neighbor state machine should</span>
<span class="comment">                   be executed with the event OneWayReceived, and the processing</span>
<span class="comment">                   of the packet stops.</span>
<span class="comment">                 */</span>
                <span class="keywordflow">if</span> (i == neighborsNeighborCount) {
                    neighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a14aa3724c4f692d5c9635bd24b9dfce7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_neighbor.html#aa11c941b2bc4a36c36fba1cb453a4172a27a074032a38e99b64583022bedacadb">OSPF::Neighbor::OneWayReceived</a>);
                }

                <span class="keywordflow">if</span> (neighborChanged) {
                    intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7efb487b2f5c22c8734c71535f05edb7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_interface.html#ae0aca9ab8ca338c25d9afa6e65fc8824a55c96f449efe8107f4dc859edfe599ee">OSPF::Interface::NeighborChange</a>);
                    <span class="comment">/* In some cases neighbors get stuck in TwoWay state after a DR</span>
<span class="comment">                       or Backup change. (CalculateDesignatedRouter runs before the</span>
<span class="comment">                       neighbors&#39; signal of DR change + this router does not become</span>
<span class="comment">                       neither DR nor backup -&gt; IsAdjacencyOK does not get called.)</span>
<span class="comment">                       So to make it work(workaround) we&#39;ll call IsAdjacencyOK for</span>
<span class="comment">                       all neighbors in TwoWay state from here. This shouldn&#39;t break</span>
<span class="comment">                       anything because if the neighbor state doesn&#39;t have to change</span>
<span class="comment">                       then NeedAdjacency returns false and nothing happnes in</span>
<span class="comment">                       IsAdjacencyOK.</span>
<span class="comment">                     */</span>
                    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> neighborCount = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a3cb63721849b942a133667f25746482b">GetNeighborCount</a>();
                    <span class="keywordflow">for</span> (i = 0; i &lt; neighborCount; i++) {
                        <a class="code" href="class_o_s_p_f_1_1_neighbor.html">OSPF::Neighbor</a>* stuckNeighbor = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a259d687e493b93dd618fe7b352c3401a">GetNeighbor</a>(i);
                        <span class="keywordflow">if</span> (stuckNeighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a934bedd2e5f14281416666a48f357bc9">GetState</a>() == <a class="code" href="class_o_s_p_f_1_1_neighbor.html#abe30518a64009a9ae44944c1036a4c0aaa2bc2a9a78de6ca762416b243c632e46">OSPF::Neighbor::TwoWayState</a>) {
                            stuckNeighbor-&gt;<a class="code" href="class_o_s_p_f_1_1_neighbor.html#a14aa3724c4f692d5c9635bd24b9dfce7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_neighbor.html#aa11c941b2bc4a36c36fba1cb453a4172afcad1cc85205f2b8c8fc2da780b8c3cb">OSPF::Neighbor::IsAdjacencyOK</a>);
                        }
                    }

                    <span class="keywordflow">if</span> (neighborsDRStateChanged) {
                        <a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html">OSPF::RouterLSA</a>* routerLSA = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a353330e70282153a34fcf9d4ee276acc">GetArea</a>()-&gt;FindRouterLSA(<a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#a24cb6c6f9b62a4e403d5171a0d36f22a">router</a>-&gt;GetRouterID());

                        <span class="keywordflow">if</span> (routerLSA != NULL) {
                            <span class="keywordtype">long</span> sequenceNumber = routerLSA-&gt;getHeader().getLsSequenceNumber();
                            <span class="keywordflow">if</span> (sequenceNumber == <a class="code" href="_o_s_p_fcommon_8h.html#a35f49b34e56993fe20d3a21d144c16d3">MAX_SEQUENCE_NUMBER</a>) {
                                routerLSA-&gt;getHeader().setLsAge(<a class="code" href="_o_s_p_fcommon_8h.html#a22c87c874ff5382c5d082b860110e363">MAX_AGE</a>);
                                intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a353330e70282153a34fcf9d4ee276acc">GetArea</a>()-&gt;FloodLSA(routerLSA);
                                routerLSA-&gt;<a class="code" href="class_o_s_p_f_1_1_l_s_a_tracking_info.html#abf7755405bc9db270e9d3db6beb9f13d">IncrementInstallTime</a>();
                            } <span class="keywordflow">else</span> {
                                <a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html">OSPF::RouterLSA</a>* newLSA = intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a353330e70282153a34fcf9d4ee276acc">GetArea</a>()-&gt;OriginateRouterLSA();

                                newLSA-&gt;getHeader().setLsSequenceNumber(sequenceNumber + 1);
                                newLSA-&gt;getHeader().setLsChecksum(0);    <span class="comment">// TODO: calculate correct LS checksum</span>
                                rebuildRoutingTable |= routerLSA-&gt;<a class="code" href="class_o_s_p_f_1_1_router_l_s_a.html#ab15ecd9bdfdb616aeacf47a4e8a7c313">Update</a>(newLSA);
                                <span class="keyword">delete</span> newLSA;

                                intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a353330e70282153a34fcf9d4ee276acc">GetArea</a>()-&gt;FloodLSA(routerLSA);
                            }
                        }
                    }
                }

                <span class="keywordflow">if</span> (backupSeen) {
                    intf-&gt;<a class="code" href="class_o_s_p_f_1_1_interface.html#a7efb487b2f5c22c8734c71535f05edb7">ProcessEvent</a>(<a class="code" href="class_o_s_p_f_1_1_interface.html#ae0aca9ab8ca338c25d9afa6e65fc8824a1449c6066285b3bb8ab9ea5794e74446">OSPF::Interface::BackupSeen</a>);
                }
            }
        }
    }

    <span class="keywordflow">if</span> (rebuildRoutingTable) {
        <a class="code" href="class_o_s_p_f_1_1_i_message_handler.html#a24cb6c6f9b62a4e403d5171a0d36f22a">router</a>-&gt;RebuildRoutingTable();
    }
}
</pre></div>
</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_hello_handler_8h.html">HelloHandler.h</a></li>
<li><a class="el" href="_hello_handler_8cc.html">HelloHandler.cc</a></li>
</ul>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespace_o_s_p_f.html">OSPF</a>      </li>
      <li class="navelem"><a class="el" href="class_o_s_p_f_1_1_hello_handler.html">HelloHandler</a>      </li>
      <li class="footer">Generated on Fri Nov 18 2011 12:47:17 for INET Framework for OMNeT++/OMNEST by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
