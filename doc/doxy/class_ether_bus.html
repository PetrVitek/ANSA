<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>INET Framework for OMNeT++/OMNEST: EtherBus Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">INET Framework for OMNeT++/OMNEST
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('class_ether_bus.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#nested-classes">Classes</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pro-methods">Protected Member Functions</a> &#124;
<a href="#pro-attribs">Protected Attributes</a>  </div>
  <div class="headertitle">
<div class="title">EtherBus Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="EtherBus" -->
<p>Implements the shared coaxial cable in classic Ethernet.  
 <a href="class_ether_bus.html#details">More...</a></p>

<p><code>#include &lt;EtherBus.h&gt;</code></p>

<p><a href="class_ether_bus-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="nested-classes"></a>
Classes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_ether_bus_1_1_bus_tap.html">BusTap</a></td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Implements the physical locations on the bus where each network entity is connected to on the bus.  <a href="struct_ether_bus_1_1_bus_tap.html#details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#abf6f3e8e6c9f66aa1db9e0924058cb54">EtherBus</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#ae964fdf7cd502083dd64d0797bb55b73">~EtherBus</a> ()</td></tr>
<tr><td colspan="2"><h2><a name="pro-methods"></a>
Protected Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage</a> (cMessage *msg)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a42424c657962b0e11eb4674f477577b8">finish</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a5a9e5b133c80ce774ba5bbdd8bc7ecf8">receiveSignal</a> (cComponent *source, simsignal_t signalID, cObject *obj)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a> (bool errorWhenAsymmetric)</td></tr>
<tr><td colspan="2"><h2><a name="pro-attribs"></a>
Protected Attributes</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">double&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a67ab8414865ce84b633ef3a6b9cab740">propagationSpeed</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="el" href="struct_ether_bus_1_1_bus_tap.html">BusTap</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a20bee343674c054e886e01b545c2e782">inputGateBaseId</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a4218ba2d441dbba9efaa97b3b25734d3">outputGateBaseId</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">dataratesDiffer</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">numMessages</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Implements the shared coaxial cable in classic Ethernet. </p>
<p>See the NED file for more description. </p>
</div><hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="abf6f3e8e6c9f66aa1db9e0924058cb54"></a><!-- doxytag: member="EtherBus::EtherBus" ref="abf6f3e8e6c9f66aa1db9e0924058cb54" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_ether_bus.html#abf6f3e8e6c9f66aa1db9e0924058cb54">EtherBus::EtherBus</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a> = <a class="code" href="def_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="ae964fdf7cd502083dd64d0797bb55b73"></a><!-- doxytag: member="EtherBus::~EtherBus" ref="ae964fdf7cd502083dd64d0797bb55b73" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_ether_bus.html#ae964fdf7cd502083dd64d0797bb55b73">EtherBus::~EtherBus</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <span class="keyword">delete</span> [] <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>;
}
</pre></div>
</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a9d48a123ea3f8fe978110d8380005116"></a><!-- doxytag: member="EtherBus::checkConnections" ref="a9d48a123ea3f8fe978110d8380005116" args="(bool errorWhenAsymmetric)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a> <a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">EtherBus::checkConnections</a> </td>
          <td>(</td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>errorWhenAsymmetric</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage()</a>, <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>, and <a class="el" href="class_ether_bus.html#a5a9e5b133c80ce774ba5bbdd8bc7ecf8">receiveSignal()</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="keywordtype">int</span> numActiveTaps = 0;

    <span class="keywordtype">double</span> datarate = 0.0;

    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>; i++)
    {
        cGate* igate = gate(<a class="code" href="class_ether_bus.html#a20bee343674c054e886e01b545c2e782">inputGateBaseId</a> + i);
        cGate* ogate = gate(<a class="code" href="class_ether_bus.html#a4218ba2d441dbba9efaa97b3b25734d3">outputGateBaseId</a> + i);
        <span class="keywordflow">if</span> (!igate-&gt;isConnected() &amp;&amp; !ogate-&gt;isConnected())
            <span class="keywordflow">continue</span>;

        <span class="keywordflow">if</span> (!igate-&gt;isConnected() || !ogate-&gt;isConnected())
        {
            <span class="comment">// half connected gate</span>
            <span class="keywordflow">if</span> (errorWhenAsymmetric)
                <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;The input or output gate not connected at tap %i&quot;</span>, i);
            <a class="code" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">dataratesDiffer</a> = <span class="keyword">true</span>;
            <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;The input or output gate not connected at tap &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;
            <span class="keywordflow">continue</span>;
        }

        numActiveTaps++;
        <span class="keywordtype">double</span> drate = igate-&gt;getIncomingTransmissionChannel()-&gt;getNominalDatarate();

        <span class="keywordflow">if</span> (numActiveTaps == 1)
            datarate = drate;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (datarate != drate)
        {
            <span class="keywordflow">if</span> (errorWhenAsymmetric)
                <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;The input datarate at tap %i differs from datarates of previous taps&quot;</span>, i);
            <a class="code" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">dataratesDiffer</a> = <span class="keyword">true</span>;
            <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;The input datarate at tap &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; differs from datarates of previous taps.\n&quot;</span>;
        }

        cChannel *outTrChannel = ogate-&gt;getTransmissionChannel();
        drate = outTrChannel-&gt;getNominalDatarate();

        <span class="keywordflow">if</span> (datarate != drate)
        {
            <span class="keywordflow">if</span> (errorWhenAsymmetric)
                <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;The output datarate at tap %i differs from datarates of previous taps&quot;</span>, i);
            <a class="code" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">dataratesDiffer</a> = <span class="keyword">true</span>;
            <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;The output datarate at tap &quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot; differs from datarates of previous taps.\n&quot;</span>;
        }

        <span class="keywordflow">if</span> (!outTrChannel-&gt;isSubscribed(POST_MODEL_CHANGE, <span class="keyword">this</span>))
            outTrChannel-&gt;subscribe(POST_MODEL_CHANGE, <span class="keyword">this</span>);
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="a42424c657962b0e11eb4674f477577b8"></a><!-- doxytag: member="EtherBus::finish" ref="a42424c657962b0e11eb4674f477577b8" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a> <a class="el" href="class_ether_bus.html#a42424c657962b0e11eb4674f477577b8">EtherBus::finish</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    simtime_t t = simTime();
    recordScalar(<span class="stringliteral">&quot;simulated time&quot;</span>, t);
    recordScalar(<span class="stringliteral">&quot;messages handled&quot;</span>, <a class="code" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">numMessages</a>);

    <span class="keywordflow">if</span> (t &gt; 0)
        recordScalar(<span class="stringliteral">&quot;messages/sec&quot;</span>, <a class="code" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">numMessages</a> / t);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a912414f3a6ec5bebe3d6fc89c3aa09d1"></a><!-- doxytag: member="EtherBus::handleMessage" ref="a912414f3a6ec5bebe3d6fc89c3aa09d1" args="(cMessage *msg)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a> <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">EtherBus::handleMessage</a> </td>
          <td>(</td>
          <td class="paramtype">cMessage *&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <span class="keywordflow">if</span> (<a class="code" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">dataratesDiffer</a>)
        <a class="code" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a>(<span class="keyword">true</span>);

    <span class="keywordflow">if</span> (!msg-&gt;isSelfMessage())
    {
        <span class="comment">// Handle frame sent down from the network entity</span>
        <span class="keywordtype">int</span> tapPoint = msg-&gt;getArrivalGate()-&gt;getIndex();
        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Frame &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; arrived on tap &quot;</span> &lt;&lt; tapPoint &lt;&lt; endl;

        <span class="comment">// create upstream and downstream events</span>
        <span class="keywordflow">if</span> (tapPoint &gt; 0)
        {
            <span class="comment">// start UPSTREAM travel</span>
            <span class="comment">// if goes downstream too, we need to make a copy</span>
            cMessage *msg2 = (tapPoint &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>-1) ? msg-&gt;dup() : msg;
            msg2-&gt;setKind(<a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>);
            msg2-&gt;setContextPointer(&amp;<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[tapPoint-1]);
            scheduleAt(simTime()+<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[tapPoint].propagationDelay[<a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>], msg2);
        }

        <span class="keywordflow">if</span> (tapPoint &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>-1)
        {
            <span class="comment">// start DOWNSTREAM travel</span>
            msg-&gt;setKind(<a class="code" href="_ether_bus_8h.html#a0fdd4161dbd1e51472cb8977d633f144">DOWNSTREAM</a>);
            msg-&gt;setContextPointer(&amp;<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[tapPoint+1]);
            scheduleAt(simTime()+<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[tapPoint].propagationDelay[<a class="code" href="_ether_bus_8h.html#a0fdd4161dbd1e51472cb8977d633f144">DOWNSTREAM</a>], msg);
        }

        <span class="keywordflow">if</span> (<a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a> == 1)
        {
            <span class="comment">// if there&#39;s only one tap, there&#39;s nothing to do</span>
            <span class="keyword">delete</span> msg;
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">// handle upstream and downstream events</span>
        <span class="keywordtype">int</span> direction = msg-&gt;getKind();
        BusTap *thistap = (BusTap *)msg-&gt;getContextPointer();
        <span class="keywordtype">int</span> tapPoint = thistap-&gt;id;

        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Event &quot;</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; on tap &quot;</span> &lt;&lt; tapPoint &lt;&lt; <span class="stringliteral">&quot;, sending out frame\n&quot;</span>;

        <span class="comment">// send out on gate</span>
        <span class="keywordtype">bool</span> isLast = (direction == <a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>) ? (tapPoint == 0) : (tapPoint == <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>-1);
        cGate* ogate = gate(<a class="code" href="class_ether_bus.html#a4218ba2d441dbba9efaa97b3b25734d3">outputGateBaseId</a> + tapPoint);
        <span class="keywordflow">if</span> (ogate-&gt;isConnected())
        {
            <span class="comment">// send out on gate</span>
            cMessage *msg2 = isLast ? msg : msg-&gt;dup();

            <span class="comment">// stop current transmission</span>
            ogate-&gt;getTransmissionChannel()-&gt;forceTransmissionFinishTime(SIMTIME_ZERO);
            send(msg2, ogate);
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// skip gate</span>
            <span class="keywordflow">if</span> (isLast)
                <span class="keyword">delete</span> msg;
        }

        <span class="comment">// if not end of the bus, schedule for next tap</span>
        <span class="keywordflow">if</span> (isLast)
        {
            <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;End of bus reached\n&quot;</span>;
        }
        <span class="keywordflow">else</span>
        {
            <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Scheduling for next tap\n&quot;</span>;
            <span class="keywordtype">int</span> nextTap = (direction==<a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>) ? (tapPoint-1) : (tapPoint+1);
            msg-&gt;setContextPointer(&amp;<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[nextTap]);
            scheduleAt(simTime()+<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[tapPoint].propagationDelay[direction], msg);
        }
    }
}
</pre></div>
</div>
</div>
<a class="anchor" id="aa9103ead3d52328992f3552042de19f5"></a><!-- doxytag: member="EtherBus::initialize" ref="aa9103ead3d52328992f3552042de19f5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a> <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">EtherBus::initialize</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <a class="code" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">numMessages</a> = 0;
    WATCH(<a class="code" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">numMessages</a>);

    <a class="code" href="class_ether_bus.html#a67ab8414865ce84b633ef3a6b9cab740">propagationSpeed</a> = par(<span class="stringliteral">&quot;propagationSpeed&quot;</span>).doubleValue();

    <span class="comment">// initialize the positions where the hosts connects to the bus</span>
    <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a> = gateSize(<span class="stringliteral">&quot;ethg&quot;</span>);
    <a class="code" href="class_ether_bus.html#a20bee343674c054e886e01b545c2e782">inputGateBaseId</a> = gateBaseId(<span class="stringliteral">&quot;ethg$i&quot;</span>);
    <a class="code" href="class_ether_bus.html#a4218ba2d441dbba9efaa97b3b25734d3">outputGateBaseId</a> = gateBaseId(<span class="stringliteral">&quot;ethg$o&quot;</span>);

    <span class="comment">// read positions and check if positions are defined in order (we&#39;re lazy to sort...)</span>
    std::vector&lt;double&gt; pos = cStringTokenizer(par(<span class="stringliteral">&quot;positions&quot;</span>).<a class="code" href="_ned_functions_8cc.html#ac32e8a82d9c3e34351155e57642cdabf">stringValue</a>()).asDoubleVector();
    <span class="keywordtype">int</span> numPos = pos.size();

    <span class="keywordflow">if</span> (numPos &gt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>)
        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Note: `positions&#39; parameter contains more values (&quot;</span>&lt;&lt; numPos &lt;&lt; <span class="stringliteral">&quot;) than &quot;</span>
              <span class="stringliteral">&quot;the number of taps (&quot;</span> &lt;&lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a> &lt;&lt; <span class="stringliteral">&quot;), ignoring excess values.\n&quot;</span>;
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (numPos &lt; numTaps &amp;&amp; numPos &gt;= 2)
        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Note: `positions&#39; parameter contains less values (&quot;</span>&lt;&lt; numPos &lt;&lt; <span class="stringliteral">&quot;) than &quot;</span>
              <span class="stringliteral">&quot;the number of taps (&quot;</span> &lt;&lt; numTaps &lt;&lt; <span class="stringliteral">&quot;), repeating distance between last 2 positions.\n&quot;</span>;
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (numPos &lt; numTaps &amp;&amp; numPos &lt; 2)
        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Note: `positions&#39; parameter contains too few values, using 5m distances.\n&quot;</span>;

    <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a> = <span class="keyword">new</span> BusTap[<a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>];

    <span class="keywordtype">int</span> i;
    <span class="keywordtype">double</span> distance = numPos &gt;= 2 ? pos[numPos-1] - pos[numPos-2] : 5;

    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>; i++)
    {
        <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#a4902b7cbbfbafed664ebcf354be45112">id</a> = i;
        <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#adf33f42b254152ba66ff16c7617f89f7">position</a> = i &lt; numPos ? pos[i] : i == 0 ? 5 : <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i-1].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#adf33f42b254152ba66ff16c7617f89f7">position</a> + distance;
    }

    <span class="keywordflow">for</span> (i = 0; i &lt; numTaps-1; i++)
    {
        <span class="keywordflow">if</span> (<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].position &gt; <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i+1].position)
            error(<span class="stringliteral">&quot;Tap positions must be ordered in ascending fashion, modify &#39;positions&#39; parameter and rerun\n&quot;</span>);
    }

    <span class="comment">// Prints out data of parameters for parameter checking...</span>
    <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Parameters of (&quot;</span> &lt;&lt; getClassName() &lt;&lt; <span class="stringliteral">&quot;) &quot;</span> &lt;&lt; getFullPath() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
    <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;propagationSpeed: &quot;</span> &lt;&lt; <a class="code" href="class_ether_bus.html#a67ab8414865ce84b633ef3a6b9cab740">propagationSpeed</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;

    <span class="comment">// Calculate propagation of delays between tap points on the bus</span>
    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>; i++)
    {
        <span class="comment">// Propagation delay between adjacent tap points</span>
        <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#ac55ab2b50802979bd08061a6f98ca6b3">propagationDelay</a>[<a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>] = (i &gt; 0) ? <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i-1].propagationDelay[<a class="code" href="_ether_bus_8h.html#a0fdd4161dbd1e51472cb8977d633f144">DOWNSTREAM</a>] : 0;
        <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#ac55ab2b50802979bd08061a6f98ca6b3">propagationDelay</a>[<a class="code" href="_ether_bus_8h.html#a0fdd4161dbd1e51472cb8977d633f144">DOWNSTREAM</a>] = (i+1 &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>) ? (<a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i+1].position - <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].position)/propagationSpeed : 0;
        <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;tap[&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;] pos: &quot;</span> &lt;&lt; <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#adf33f42b254152ba66ff16c7617f89f7">position</a> &lt;&lt;
              <span class="stringliteral">&quot;  upstream delay: &quot;</span> &lt;&lt; <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#ac55ab2b50802979bd08061a6f98ca6b3">propagationDelay</a>[<a class="code" href="_ether_bus_8h.html#aecc70b06b9893c001633b54e288ff29d">UPSTREAM</a>] &lt;&lt;
              <span class="stringliteral">&quot;  downstream delay: &quot;</span> &lt;&lt; <a class="code" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">tap</a>[i].<a class="code" href="struct_ether_bus_1_1_bus_tap.html#ac55ab2b50802979bd08061a6f98ca6b3">propagationDelay</a>[<a class="code" href="_ether_bus_8h.html#a0fdd4161dbd1e51472cb8977d633f144">DOWNSTREAM</a>] &lt;&lt; endl;
    }
    <a class="code" href="_i_n_e_t_defs_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;

    <span class="comment">// ensure we receive frames when their first bits arrive</span>
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">numTaps</a>; i++)
        gate(<a class="code" href="class_ether_bus.html#a20bee343674c054e886e01b545c2e782">inputGateBaseId</a> + i)-&gt;setDeliverOnReceptionStart(<span class="keyword">true</span>);
    subscribe(POST_MODEL_CHANGE, <span class="keyword">this</span>);  <span class="comment">// we&#39;ll need to do the same for dynamically added gates as well</span>

    <a class="code" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a>(<span class="keyword">true</span>);
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5a9e5b133c80ce774ba5bbdd8bc7ecf8"></a><!-- doxytag: member="EtherBus::receiveSignal" ref="a5a9e5b133c80ce774ba5bbdd8bc7ecf8" args="(cComponent *source, simsignal_t signalID, cObject *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="timer__queue_8h.html#a07640d68b3fdfaa5c48a36265e8f10b8">void</a> <a class="el" href="class_ether_bus.html#a5a9e5b133c80ce774ba5bbdd8bc7ecf8">EtherBus::receiveSignal</a> </td>
          <td>(</td>
          <td class="paramtype">cComponent *&#160;</td>
          <td class="paramname"><em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">simsignal_t&#160;</td>
          <td class="paramname"><em>signalID</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">cObject *&#160;</td>
          <td class="paramname"><em>obj</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [protected, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    Enter_Method_Silent();

    ASSERT(signalID == POST_MODEL_CHANGE);

    <span class="comment">// throw error if new gates have been added</span>
    cPostGateVectorResizeNotification *notif = <span class="keyword">dynamic_cast&lt;</span>cPostGateVectorResizeNotification*<span class="keyword">&gt;</span>(obj);
    <span class="keywordflow">if</span> (notif)
    {
        <span class="keywordflow">if</span> (strcmp(notif-&gt;gateName, <span class="stringliteral">&quot;ethg&quot;</span>) == 0)
            <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;EtherBus does not allow adding/removing links dynamically&quot;</span>);
    }

    cPostPathCreateNotification *connNotif = <span class="keyword">dynamic_cast&lt;</span>cPostPathCreateNotification *<span class="keyword">&gt;</span>(obj);
    <span class="keywordflow">if</span> (connNotif)
    {
        <span class="keywordflow">if</span> ((<span class="keyword">this</span> == connNotif-&gt;pathStartGate-&gt;getOwnerModule()) || (<span class="keyword">this</span> == connNotif-&gt;pathEndGate-&gt;getOwnerModule()))
            <a class="code" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a>(<span class="keyword">false</span>);
        <span class="keywordflow">return</span>;
    }

    cPostPathCutNotification *cutNotif = <span class="keyword">dynamic_cast&lt;</span>cPostPathCutNotification *<span class="keyword">&gt;</span>(obj);
    <span class="keywordflow">if</span> (cutNotif)
    {
        <span class="keywordflow">if</span> ((<span class="keyword">this</span> == cutNotif-&gt;pathStartGate-&gt;getOwnerModule()) || (<span class="keyword">this</span> == cutNotif-&gt;pathEndGate-&gt;getOwnerModule()))
            <a class="code" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a>(<span class="keyword">false</span>);
        <span class="keywordflow">return</span>;
    }

    <span class="comment">// note: we are subscribed to the channel object too</span>
    cPostParameterChangeNotification *parNotif = <span class="keyword">dynamic_cast&lt;</span>cPostParameterChangeNotification *<span class="keyword">&gt;</span>(obj);
    <span class="keywordflow">if</span> (parNotif)
    {
        cChannel *channel = <span class="keyword">dynamic_cast&lt;</span>cDatarateChannel *<span class="keyword">&gt;</span>(parNotif-&gt;par-&gt;getOwner());
        <span class="keywordflow">if</span> (channel)
        {
            cGate *gate = channel-&gt;getSourceGate();
            <span class="keywordflow">if</span> (gate-&gt;pathContains(<span class="keyword">this</span>))
                <a class="code" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections</a>(<span class="keyword">false</span>);
        }
        <span class="keywordflow">return</span>;
    }
}
</pre></div>
</div>
</div>
<hr/><h2>Member Data Documentation</h2>
<a class="anchor" id="ab7fa7133dd2ec7057b4593fd3c8c6d4d"></a><!-- doxytag: member="EtherBus::dataratesDiffer" ref="ab7fa7133dd2ec7057b4593fd3c8c6d4d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="class_ether_bus.html#ab7fa7133dd2ec7057b4593fd3c8c6d4d">EtherBus::dataratesDiffer</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections()</a>, and <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage()</a>.</p>

</div>
</div>
<a class="anchor" id="a20bee343674c054e886e01b545c2e782"></a><!-- doxytag: member="EtherBus::inputGateBaseId" ref="a20bee343674c054e886e01b545c2e782" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="class_ether_bus.html#a20bee343674c054e886e01b545c2e782">EtherBus::inputGateBaseId</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections()</a>, and <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>.</p>

</div>
</div>
<a class="anchor" id="a2f405fe03dc3c21f4580d8b7df4e1b27"></a><!-- doxytag: member="EtherBus::numMessages" ref="a2f405fe03dc3c21f4580d8b7df4e1b27" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long <a class="el" href="class_ether_bus.html#a2f405fe03dc3c21f4580d8b7df4e1b27">EtherBus::numMessages</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a42424c657962b0e11eb4674f477577b8">finish()</a>, and <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>.</p>

</div>
</div>
<a class="anchor" id="a03020b52b613fcc7100dc8881889308f"></a><!-- doxytag: member="EtherBus::numTaps" ref="a03020b52b613fcc7100dc8881889308f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="class_ether_bus.html#a03020b52b613fcc7100dc8881889308f">EtherBus::numTaps</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections()</a>, <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage()</a>, and <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>.</p>

</div>
</div>
<a class="anchor" id="a4218ba2d441dbba9efaa97b3b25734d3"></a><!-- doxytag: member="EtherBus::outputGateBaseId" ref="a4218ba2d441dbba9efaa97b3b25734d3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="class_ether_bus.html#a4218ba2d441dbba9efaa97b3b25734d3">EtherBus::outputGateBaseId</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#a9d48a123ea3f8fe978110d8380005116">checkConnections()</a>, <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage()</a>, and <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>.</p>

</div>
</div>
<a class="anchor" id="a67ab8414865ce84b633ef3a6b9cab740"></a><!-- doxytag: member="EtherBus::propagationSpeed" ref="a67ab8414865ce84b633ef3a6b9cab740" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">double <a class="el" href="class_ether_bus.html#a67ab8414865ce84b633ef3a6b9cab740">EtherBus::propagationSpeed</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>.</p>

</div>
</div>
<a class="anchor" id="adac598e12927e743757602578adc2a33"></a><!-- doxytag: member="EtherBus::tap" ref="adac598e12927e743757602578adc2a33" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="struct_ether_bus_1_1_bus_tap.html">BusTap</a>* <a class="el" href="class_ether_bus.html#adac598e12927e743757602578adc2a33">EtherBus::tap</a><code> [protected]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="class_ether_bus.html#abf6f3e8e6c9f66aa1db9e0924058cb54">EtherBus()</a>, <a class="el" href="class_ether_bus.html#a912414f3a6ec5bebe3d6fc89c3aa09d1">handleMessage()</a>, <a class="el" href="class_ether_bus.html#aa9103ead3d52328992f3552042de19f5">initialize()</a>, and <a class="el" href="class_ether_bus.html#ae964fdf7cd502083dd64d0797bb55b73">~EtherBus()</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="_ether_bus_8h.html">EtherBus.h</a></li>
<li><a class="el" href="_ether_bus_8cc.html">EtherBus.cc</a></li>
</ul>
</div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="class_ether_bus.html">EtherBus</a>      </li>

    <li class="footer">Generated on Tue Aug 7 2012 16:01:23 for INET Framework for OMNeT++/OMNEST by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
